<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chatbot Luật Giao Thông Đường Bộ Việt Nam</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            height: 100vh;
            overflow: hidden;
        }

        .container {
            display: flex;
            flex-direction: column;
            height: 100vh;
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 0;
        }

        .header {
            background: linear-gradient(135deg, #2c3e50, #3498db);
            color: white;
            padding: 20px;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .header h1 {
            font-size: 1.5rem;
            margin-bottom: 5px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .header p {
            opacity: 0.9;
            font-size: 0.9rem;
        }

        .chat-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .messages-container {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            scroll-behavior: smooth;
        }

        .message {
            margin-bottom: 20px;
            display: flex;
            align-items: flex-start;
            gap: 12px;
            opacity: 0;
            transform: translateY(20px);
            animation: messageSlideIn 0.3s ease-out forwards;
        }

        @keyframes messageSlideIn {
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message.user {
            flex-direction: row-reverse;
        }

        .message-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            font-size: 18px;
        }

        .user .message-avatar {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }

        .bot .message-avatar {
            background: linear-gradient(135deg, #2c3e50, #3498db);
            color: white;
        }

        .message-content {
            max-width: 70%;
            padding: 15px 20px;
            border-radius: 20px;
            position: relative;
            word-wrap: break-word;
            line-height: 1.5;
        }

        .user .message-content {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border-bottom-right-radius: 5px;
        }

        .bot .message-content {
            background: #f8f9fa;
            color: #333;
            border: 1px solid #e9ecef;
            border-bottom-left-radius: 5px;
        }

        .typing-indicator {
            display: none;
            align-items: center;
            gap: 12px;
            margin-bottom: 20px;
        }

        .typing-dots {
            display: flex;
            gap: 4px;
            padding: 15px 20px;
            background: #f8f9fa;
            border-radius: 20px;
            border-bottom-left-radius: 5px;
        }

        .typing-dots span {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #666;
            animation: typing 1.4s infinite;
        }

        .typing-dots span:nth-child(2) {
            animation-delay: 0.2s;
        }

        .typing-dots span:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes typing {
            0%, 60%, 100% {
                transform: translateY(0);
                opacity: 0.4;
            }
            30% {
                transform: translateY(-10px);
                opacity: 1;
            }
        }

        .input-container {
            padding: 20px;
            background: white;
            border-top: 1px solid #e9ecef;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
        }

        .input-form {
            display: flex;
            gap: 12px;
            align-items: flex-end;
            max-width: 100%;
        }

        .input-wrapper {
            flex: 1;
            position: relative;
        }

        #messageInput {
            width: 100%;
            min-height: 50px;
            max-height: 120px;
            padding: 15px 20px;
            border: 2px solid #e9ecef;
            border-radius: 25px;
            font-size: 16px;
            resize: none;
            outline: none;
            transition: all 0.3s ease;
            font-family: inherit;
            line-height: 1.4;
        }

        #messageInput:focus {
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }

        #sendButton {
            width: 50px;
            height: 50px;
            border: none;
            border-radius: 50%;
            background: linear-gradient(135deg, #3498db, #2c3e50);
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            transition: all 0.3s ease;
            flex-shrink: 0;
        }

        #sendButton:hover:not(:disabled) {
            transform: scale(1.05);
            box-shadow: 0 4px 15px rgba(52, 152, 219, 0.3);
        }

        #sendButton:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .suggestions {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .suggestion-btn {
            padding: 8px 16px;
            background: white;
            border: 2px solid #e9ecef;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
            color: #666;
        }

        .suggestion-btn:hover {
            background: #f8f9fa;
            border-color: #3498db;
            color: #3498db;
        }

        .welcome-message {
            text-align: center;
            padding: 40px 20px;
            color: #666;
        }

        .welcome-message h2 {
            margin-bottom: 15px;
            color: #2c3e50;
        }

        .welcome-message p {
            margin-bottom: 25px;
            line-height: 1.6;
        }

        .status-indicator {
            position: absolute;
            top: 20px;
            right: 20px;
            display: flex;
            align-items: center;
            gap: 8px;
            background: rgba(255, 255, 255, 0.2);
            padding: 8px 12px;
            border-radius: 20px;
            font-size: 12px;
            opacity: 0.9;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #2ecc71;
        }

        .error-message {
            background: #e74c3c !important;
            color: white !important;
        }

        @media (max-width: 768px) {
            .container {
                height: 100vh;
                border-radius: 0;
            }
            
            .message-content {
                max-width: 85%;
            }
            
            .header h1 {
                font-size: 1.2rem;
            }
            
            .suggestions {
                flex-direction: column;
            }
            
            .suggestion-btn {
                text-align: center;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="status-indicator">
                <div class="status-dot"></div>
                <span>Đang kết nối...</span>
            </div>
            <h1>
                <i class="fas fa-car"></i>
                Chatbot Luật Giao Thông Đường Bộ Việt Nam
            </h1>
            <p>Hỏi đáp về các quy định và luật lệ giao thông đường bộ</p>
        </div>

        <div class="chat-container">
            <div class="messages-container" id="messagesContainer">
                <div class="welcome-message">
                    <h2><i class="fas fa-robot"></i> Xin chào!</h2>
                    <p>Tôi là trợ lý AI chuyên về luật giao thông đường bộ Việt Nam. Tôi có thể giúp bạn tìm hiểu về các quy định, mức phạt, thủ tục và các vấn đề liên quan đến giao thông.</p>
                    <p><strong>Hãy đặt câu hỏi hoặc chọn một gợi ý bên dưới:</strong></p>
                </div>
            </div>

            <div class="typing-indicator" id="typingIndicator">
                <div class="message-avatar bot">
                    <i class="fas fa-robot"></i>
                </div>
                <div class="typing-dots">
                    <span></span>
                    <span></span>
                    <span></span>
                </div>
            </div>
        </div>

        <div class="input-container">
            <div class="suggestions">
                <div class="suggestion-btn" onclick="sendSuggestion('Mức phạt vi phạm giao thông mới nhất 2024')">
                    <i class="fas fa-gavel"></i> Mức phạt vi phạm giao thông
                </div>
                <div class="suggestion-btn" onclick="sendSuggestion('Thủ tục đăng ký xe ô tô lần đầu')">
                    <i class="fas fa-file-alt"></i> Đăng ký xe ô tô
                </div>
                <div class="suggestion-btn" onclick="sendSuggestion('Điều kiện thi bằng lái xe B2')">
                    <i class="fas fa-id-card"></i> Bằng lái xe B2
                </div>
                <div class="suggestion-btn" onclick="sendSuggestion('Quy định về bảo hiểm xe cơ giới')">
                    <i class="fas fa-shield-alt"></i> Bảo hiểm xe
                </div>
            </div>
            
            <form class="input-form" onsubmit="sendMessage(event)">
                <div class="input-wrapper">
                    <textarea 
                        id="messageInput" 
                        placeholder="Nhập câu hỏi về luật giao thông..."
                        rows="1"
                        oninput="autoResize(this)"
                        onkeydown="handleKeyPress(event)"
                    ></textarea>
                </div>
                <button type="submit" id="sendButton">
                    <i class="fas fa-paper-plane"></i>
                </button>
            </form>
        </div>
    </div>

    <script>
        // Configuration
        const API_BASE_URL = 'http://localhost:8000/api/v1';
        
        // DOM Elements
        const messagesContainer = document.getElementById('messagesContainer');
        const messageInput = document.getElementById('messageInput');
        const sendButton = document.getElementById('sendButton');
        const typingIndicator = document.getElementById('typingIndicator');
        const statusIndicator = document.querySelector('.status-indicator span');
        const statusDot = document.querySelector('.status-dot');

        // State
        let isTyping = false;
        let conversationHistory = [];

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            checkAPIConnection();
            messageInput.focus();
        });

        // Check API connection
        async function checkAPIConnection() {
            try {
                const response = await fetch(`${API_BASE_URL}/health`);
                if (response.ok) {
                    statusIndicator.textContent = 'Đã kết nối';
                    statusDot.style.background = '#2ecc71';
                } else {
                    throw new Error('API not responding');
                }
            } catch (error) {
                statusIndicator.textContent = 'Mất kết nối';
                statusDot.style.background = '#e74c3c';
                console.error('API connection error:', error);
            }
        }

        // Auto resize textarea
        function autoResize(textarea) {
            textarea.style.height = 'auto';
            textarea.style.height = Math.min(textarea.scrollHeight, 120) + 'px';
        }

        // Handle key press
        function handleKeyPress(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendMessage(event);
            }
        }

        // Send suggestion
        function sendSuggestion(text) {
            messageInput.value = text;
            sendMessage();
        }

        // Send message
        async function sendMessage(event) {
            if (event) event.preventDefault();
            
            const message = messageInput.value.trim();
            if (!message || isTyping) return;

            // Clear input and disable button
            messageInput.value = '';
            messageInput.style.height = 'auto';
            setLoading(true);

            // Add user message
            addMessage(message, 'user');
            
            // Add to conversation history
            conversationHistory.push({
                role: 'user',
                content: message
            });

            try {
                // Show typing indicator
                showTypingIndicator();

                // Send request to API
                const response = await fetch(`${API_BASE_URL}/chat`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        message: message,
                        conversation_history: conversationHistory.slice(-10) // Keep last 10 messages
                    })
                });

                hideTypingIndicator();

                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(errorData.message || `HTTP ${response.status}`);
                }

                const data = await response.json();
                
                // Add bot response
                addMessage(data.response || 'Xin lỗi, tôi không thể trả lời câu hỏi này.', 'bot');
                
                // Add to conversation history
                conversationHistory.push({
                    role: 'assistant',
                    content: data.response
                });

                // Update status
                statusIndicator.textContent = 'Đã kết nối';
                statusDot.style.background = '#2ecc71';

            } catch (error) {
                hideTypingIndicator();
                console.error('Error sending message:', error);
                
                let errorMessage = 'Xin lỗi, đã có lỗi xảy ra. Vui lòng thử lại sau.';
                
                if (error.message.includes('Failed to fetch')) {
                    errorMessage = 'Không thể kết nối đến server. Vui lòng kiểm tra kết nối mạng.';
                    statusIndicator.textContent = 'Mất kết nối';
                    statusDot.style.background = '#e74c3c';
                }
                
                addMessage(errorMessage, 'bot', true);
            } finally {
                setLoading(false);
                messageInput.focus();
            }
        }

        // Add message to chat
        function addMessage(content, sender, isError = false) {
            // Remove welcome message if exists
            const welcomeMessage = document.querySelector('.welcome-message');
            if (welcomeMessage) {
                welcomeMessage.remove();
            }

            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}`;

            const avatarDiv = document.createElement('div');
            avatarDiv.className = 'message-avatar';
            avatarDiv.innerHTML = sender === 'user' ? '<i class="fas fa-user"></i>' : '<i class="fas fa-robot"></i>';

            const contentDiv = document.createElement('div');
            contentDiv.className = `message-content ${isError ? 'error-message' : ''}`;
            contentDiv.innerHTML = formatMessage(content);

            messageDiv.appendChild(avatarDiv);
            messageDiv.appendChild(contentDiv);

            messagesContainer.appendChild(messageDiv);
            scrollToBottom();
        }

        // Format message content
        function formatMessage(content) {
            // Basic markdown-like formatting
            return content
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/\*(.*?)\*/g, '<em>$1</em>')
                .replace(/\n/g, '<br>');
        }

        // Show typing indicator
        function showTypingIndicator() {
            isTyping = true;
            typingIndicator.style.display = 'flex';
            scrollToBottom();
        }

        // Hide typing indicator
        function hideTypingIndicator() {
            isTyping = false;
            typingIndicator.style.display = 'none';
        }

        // Set loading state
        function setLoading(loading) {
            sendButton.disabled = loading;
            messageInput.disabled = loading;
            
            if (loading) {
                sendButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
            } else {
                sendButton.innerHTML = '<i class="fas fa-paper-plane"></i>';
            }
        }

        // Scroll to bottom
        function scrollToBottom() {
            setTimeout(() => {
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            }, 100);
        }

        // Check API connection periodically
        setInterval(checkAPIConnection, 30000);
    </script>
</body>
</html>